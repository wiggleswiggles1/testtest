<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TechBuilds Auto-TTS</title>
    <script src="https://js.pusher.com/8.3.0/pusher.min.js"></script>
    <style>
        body { background: transparent; overflow: hidden; margin: 0; padding: 0; }
        /* Tiny green dot so you know it's active in OBS */
        #status { position: fixed; top: 5px; right: 5px; width: 6px; height: 6px; background: #53fc18; border-radius: 50%; opacity: 0.4; }
    </style>
</head>
<body>
    <div id="status"></div>

<script>
    // --- CONFIGURATION ---
    const KICK_CHATROOM_ID = "1085080"; 
    const TWITCH_CHANNEL = "xstr8xsavagex"; 
    const TWITCH_OAUTH = "oauth:sb20z6c3zuvzspk3d4ny8p9jp0fjkm";

    const USER_BLACKLIST = ["streamelements", "nightbot", "botrix", "kicktools", "kickbot", "growopgame", "missxss", "BotRixOficial"]; 
    const WORD_BLACKLIST = ["http", ".com", "www."]; 
    const PREFIX_BLOCK = ["!", "/", "."]; 

    let voices = [];
    
    // Load voices and filter for English
    function loadVoices() { 
        voices = window.speechSynthesis.getVoices().filter(v => v.lang.includes('en')); 
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    // --- KICK CONNECTION ---
    const pusher = new Pusher('32cbd69e4b950bf97679', { cluster: 'us2', forceTLS: true });
    const kickChannel = pusher.subscribe(`chatrooms.${KICK_CHATROOM_ID}.v2`);
    kickChannel.bind('App\\Events\\ChatMessageEvent', (data) => {
        const chat = typeof data === 'string' ? JSON.parse(data) : data;
        processAndSpeak(chat.sender.username, chat.content);
    });

    // --- TWITCH CONNECTION (With Emote Stripping) ---
    function connectTwitch() {
        const socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        socket.onopen = () => {
            socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
            socket.send(`PASS ${TWITCH_OAUTH}`);
            socket.send(`NICK ${TWITCH_CHANNEL}`);
            socket.send(`JOIN #${TWITCH_CHANNEL}`);
        };
        socket.onmessage = (event) => {
            const raw = event.data;
            if (raw.startsWith('PING')) { socket.send('PONG :tmi.twitch.tv'); return; }
            if (raw.includes("PRIVMSG")) {
                const parts = raw.split(' ');
                const tags = parts[0].startsWith('@') ? parts[0] : "";
                const user = raw.match(/:([^!]+)!/)?.[1];
                let message = raw.split(`PRIVMSG #${TWITCH_CHANNEL} :`)[1]?.trim();
                
                if (!user || !message) return;

                // Strip Twitch Emotes using your specific logic
                if (tags.includes("emotes=")) {
                    const emoteTag = tags.split('emotes=')[1].split(';')[0];
                    if (emoteTag) {
                        const positions = [];
                        emoteTag.split('/').forEach(emote => {
                            const ranges = emote.split(':')[1];
                            ranges.split(',').forEach(range => {
                                const [start, end] = range.split('-').map(Number);
                                positions.push({start, end});
                            });
                        });
                        positions.sort((a, b) => b.start - a.start).forEach(pos => {
                            message = message.slice(0, pos.start) + message.slice(pos.end + 1);
                        });
                    }
                }
                processAndSpeak(user, message);
            }
        };
        socket.onclose = () => setTimeout(connectTwitch, 5000);
    }
    connectTwitch();

    // --- SHARED LOGIC & FILTERS ---
    function processAndSpeak(user, raw) {
        const username = user.toLowerCase();
        const trimmedRaw = raw.trim();

        if (USER_BLACKLIST.includes(username)) return;
        if (PREFIX_BLOCK.some(p => trimmedRaw.startsWith(p))) return;

        // Clean Kick Emotes and weird characters
        let clean = raw
            .replace(/<[^>]*>?/gm, '')           // HTML
            .replace(/:[a-zA-Z0-9_]+:/g, '')    // :emote:
            .replace(/\[[^\]]*\]/g, '')         // [kick_emote]
            .replace(/\p{Emoji}/gu, '')         // Unicode Emojis
            .replace(/\p{Symbol}/gu, '')        // Symbols
            .replace(/\s+/g, ' ')               // Extra spaces
            .trim();

        if (WORD_BLACKLIST.some(word => clean.toLowerCase().includes(word.toLowerCase()))) return;

        // Final check: Does it have actual letters/numbers left?
        if (/[a-zA-Z0-9]{2,}/.test(clean)) {
            speak(user, clean);
        }
    }

    // --- SPEAK FUNCTION (Zero-Interaction Friendly) ---
    function speak(user, text) {
        // Fix for Chrome/OBS: If the engine is stuck, resume it
        if (window.speechSynthesis.paused) {
            window.speechSynthesis.resume();
        }

        const speech = new SpeechSynthesisUtterance(`${user} says: ${text}`);
        
        if (voices.length > 0) {
            const seed = user.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            speech.voice = voices[seed % voices.length];
        }
        
        speech.rate = 1.1; 
        speech.pitch = 1.0;
        
        window.speechSynthesis.speak(speech);
    }

    // Periodically keep the audio engine alive for OBS
    setInterval(() => {
        if (!window.speechSynthesis.speaking) {
            window.speechSynthesis.pause();
            window.speechSynthesis.resume();
        }
    }, 10000);

</script>
</body>
</html>