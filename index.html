<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zero-Interaction TTS | TechBuilds</title>
    <script src="https://js.pusher.com/8.3.0/pusher.min.js"></script>
    <style>
        /* Hidden UI since no interaction is needed */
        body { background: transparent; overflow: hidden; margin: 0; padding: 0; }
        #status-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            background: #53fc18;
            border-radius: 50%;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div id="status-indicator"></div>

<script>
    // --- CONFIGURATION ---
    const KICK_CHATROOM_ID = "1085080"; 
    const TWITCH_CHANNEL = "xstr8xsavagex"; 
    const TWITCH_OAUTH = "oauth:sb20z6c3zuvzspk3d4ny8p9jp0fjkm";

    const USER_BLACKLIST = ["streamelements", "nightbot", "botrix", "kicktools", "kickbot", "growopgame", "missxss", "BotRixOficial"]; 
    const PREFIX_BLOCK = ["!", "/"]; 

    let voices = [];
    
    function loadVoices() { 
        voices = window.speechSynthesis.getVoices().filter(v => v.lang.includes('en')); 
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    // --- KICK CONNECTION ---
    const pusher = new Pusher('32cbd69e4b950bf97679', { cluster: 'us2', forceTLS: true });
    const kickChannel = pusher.subscribe(`chatrooms.${KICK_CHATROOM_ID}.v2`);
    kickChannel.bind('App\\Events\\ChatMessageEvent', (data) => {
        const chat = typeof data === 'string' ? JSON.parse(data) : data;
        processAndSpeak(chat.sender.username, chat.content);
    });

    // --- TWITCH CONNECTION ---
    function connectTwitch() {
        const socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        socket.onopen = () => {
            socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
            socket.send(`PASS ${TWITCH_OAUTH}`);
            socket.send(`NICK ${TWITCH_CHANNEL}`);
            socket.send(`JOIN #${TWITCH_CHANNEL}`);
        };
        socket.onmessage = (event) => {
            const raw = event.data.trim();
            if (raw.startsWith('PING')) { socket.send('PONG :tmi.twitch.tv'); return; }
            if (!raw.includes('PRIVMSG')) return;
            const userMatch = raw.match(/:([^!]+)!/);
            if (!userMatch) return;
            const user = userMatch[1];
            const colonIndex = raw.lastIndexOf(' :');
            if (colonIndex === -1) return;
            let message = raw.substring(colonIndex + 2).trim();
            processAndSpeak(user, message);
        };
        socket.onclose = () => setTimeout(connectTwitch, 5000);
    }
    connectTwitch();

    function processAndSpeak(user, raw) {
        if (USER_BLACKLIST.includes(user.toLowerCase())) return;
        if (PREFIX_BLOCK.some(p => raw.trim().startsWith(p))) return;

        let clean = raw.replace(/\p{Emoji}/gu, '').replace(/\s+/g, ' ').trim();
        if (clean.length < 2) return;

        speak(user, clean);
    }

    function speak(user, text) {
        const speech = new SpeechSynthesisUtterance(`${user} says: ${text}`);
        if (voices.length > 0) {
            const seed = user.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            speech.voice = voices[seed % voices.length];
        }
        speech.rate = 1.0;
        window.speechSynthesis.speak(speech);
    }
</script>
</body>
</html>