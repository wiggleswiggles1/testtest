<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Custom MultiChat TTS | TechBuilds</title>
    <script src="https://js.pusher.com/8.3.0/pusher.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            background: transparent; 
            overflow: hidden; 
            margin: 0; 
            padding: 0; 
            font-family: 'Inter', sans-serif; 
        }
        
        /* The Unlocker Overlay */
        #unlocker { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh; 
            z-index: 9999; 
            background: rgba(14, 14, 16, 0.95); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            text-align: center; 
            cursor: pointer; 
            flex-direction: column;
            transition: opacity 0.5s ease;
        }

        .card {
            background: #18181b;
            padding: 40px;
            border-radius: 20px;
            border: 2px solid #53fc18;
            box-shadow: 0 0 30px rgba(83, 252, 24, 0.2);
        }

        h1 { color: #53fc18; margin-bottom: 10px; }
        p { color: #adadb8; font-size: 1.2em; }
        .pulsate { animation: pulse 2s infinite; color: #53fc18; font-weight: bold; margin-top: 20px; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="unlocker">
        <div class="card">
            <h1>Custom Multi-TTS Overlay</h1>
            <h3>By TechBuilds</h3>
            <p>Kick: 1085080 | Twitch: xstr8xsavagex</p>
            <div class="pulsate">CLICK ANYWHERE TO ACTIVATE AUDIO</div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const KICK_CHATROOM_ID = "1085080"; 
    const TWITCH_CHANNEL = "xstr8xsavagex"; 
    const TWITCH_OAUTH = "oauth:sb20z6c3zuvzspk3d4ny8p9jp0fjkm";

    const USER_BLACKLIST = ["streamelements", "nightbot", "botrix", "kicktools", "kickbot", "growopgame", "missxss", "BotRixOficial"]; 
    const WORD_BLACKLIST = ["http", ".com", "www."]; 
    const PREFIX_BLOCK = ["!", "/"]; 

    let voices = [];
    let active = false;

    // Load voices and filter for English
    function loadVoices() { 
        voices = window.speechSynthesis.getVoices().filter(v => v.lang.includes('en')); 
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    // Unlock Audio Context
    document.getElementById('unlocker').addEventListener('click', function() {
        active = true;
        const test = new SpeechSynthesisUtterance("TTS System Online");
        if (voices.length > 0) test.voice = voices[0];
        window.speechSynthesis.speak(test);
        
        this.style.opacity = '0';
        setTimeout(() => this.style.display = 'none', 500);
    });

    // --- REPETITION SPAM FILTER ---
    function isRepetitiveSpam(text) {
        const lower = text.toLowerCase().trim();
        const words = lower.split(/\s+/).filter(w => w.length > 0);
        if (words.length === 0) return true;
        if (words.length >= 5) {
            const first = words[0];
            if (first.length <= 3 && words.every(w => w === first)) return true;
        }
        const uniqueWords = new Set(words);
        if (words.length >= 6 && uniqueWords.size <= 2) return true;
        return false;
    }

    // --- KICK CONNECTION ---
    const pusher = new Pusher('32cbd69e4b950bf97679', { cluster: 'us2', forceTLS: true });
    const kickChannel = pusher.subscribe(`chatrooms.${KICK_CHATROOM_ID}.v2`);
    kickChannel.bind('App\\Events\\ChatMessageEvent', (data) => {
        const chat = typeof data === 'string' ? JSON.parse(data) : data;
        processAndSpeak(chat.sender.username, chat.content, "Kick");
    });

    // --- TWITCH CONNECTION ---
    function connectTwitch() {
        const socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        socket.onopen = () => {
            socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
            socket.send(`PASS ${TWITCH_OAUTH}`);
            socket.send(`NICK ${TWITCH_CHANNEL}`);
            socket.send(`JOIN #${TWITCH_CHANNEL}`);
        };
        socket.onmessage = (event) => {
            const raw = event.data.trim();
            if (raw.startsWith('PING')) { socket.send('PONG :tmi.twitch.tv'); return; }
            if (!raw.includes('PRIVMSG')) return;

            const userMatch = raw.match(/:([^!]+)!/);
            if (!userMatch) return;
            const user = userMatch[1];

            const colonIndex = raw.lastIndexOf(' :');
            if (colonIndex === -1) return;
            let message = raw.substring(colonIndex + 2).trim();

            // Strip Twitch Emotes
            if (raw.startsWith('@')) {
                const tagsSection = raw.slice(1, raw.indexOf(' '));
                const emotesMatch = tagsSection.match(/emotes=([^;]*)/);
                if (emotesMatch && emotesMatch[1] !== '') {
                    const positions = [];
                    emotesMatch[1].split('/').forEach(block => {
                        const ranges = block.split(':')[1];
                        if (ranges) {
                            ranges.split(',').forEach(range => {
                                const [start, end] = range.split('-').map(Number);
                                positions.push({start, end});
                            });
                        }
                    });
                    positions.sort((a, b) => b.start - a.start);
                    positions.forEach(pos => {
                        message = message.slice(0, pos.start) + message.slice(pos.end + 1);
                    });
                }
            }
            processAndSpeak(user, message, "Twitch");
        };
        socket.onclose = () => setTimeout(connectTwitch, 5000);
    }
    connectTwitch();

    // --- SHARED PROCESSING ---
    function processAndSpeak(user, raw, platform) {
        const username = user.toLowerCase();
        const trimmedRaw = raw.trim();

        if (USER_BLACKLIST.includes(username)) return;
        if (PREFIX_BLOCK.some(p => trimmedRaw.startsWith(p))) return;

        let clean = raw
            .replace(/<[^>]*>?/gm, '')           
            .replace(/:[a-zA-Z0-9_]+:/g, '')    
            .replace(/\[[^\]]*\]/g, '')         
            .replace(/\p{Emoji}/gu, '')         
            .replace(/\p{Symbol}/gu, '')        
            .replace(/\s+/g, ' ')               
            .trim();

        if (WORD_BLACKLIST.some(word => clean.toLowerCase().includes(word.toLowerCase()))) return;
        if (/[a-zA-Z0-9]{2,}/.test(clean) === false) return;
        if (isRepetitiveSpam(clean)) return;

        speak(user, clean);
    }

    function speak(user, text) {
        if (!active) return;
        
        // Randomly assign a voice based on username so regular chatters have "their" voice
        const speech = new SpeechSynthesisUtterance(`${user} says: ${text}`);
        
        if (voices.length > 0) {
            const seed = user.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            speech.voice = voices[seed % voices.length];
        }
        
        speech.rate = 1.0;
        speech.pitch = 1.0;
        window.speechSynthesis.speak(speech);
    }
</script>
</body>
</html>